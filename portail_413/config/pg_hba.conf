# DCOP (413) - Configuration d'Authentification PostgreSQL (pg_hba.conf)
# Règles de sécurité pour l'accès à la base de données

# =============================================================================
# RÈGLES D'AUTHENTIFICATION
# =============================================================================

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# Connexions locales (dans le conteneur)
local   all             postgres                                peer
local   all             dcop_user                               scram-sha-256

# Connexions IPv4 locales
host    all             postgres        127.0.0.1/32            scram-sha-256
host    all             dcop_user       127.0.0.1/32            scram-sha-256

# Connexions depuis le réseau Docker (backend)
host    dcop_413        dcop_user       172.25.2.0/24           scram-sha-256

# Connexions depuis l'hôte Docker (pour développement)
host    dcop_413        dcop_user       172.17.0.0/16           scram-sha-256

# Connexions IPv6 locales
host    all             postgres        ::1/128                 scram-sha-256
host    dcop_413        dcop_user       ::1/128                 scram-sha-256

# =============================================================================
# SÉCURITÉ RENFORCÉE
# =============================================================================

# Refuser toutes les autres connexions
host    all             all             0.0.0.0/0               reject
host    all             all             ::/0                    reject

# =============================================================================
# RÈGLES SPÉCIALES POUR LE DÉVELOPPEMENT
# =============================================================================

# Permettre les connexions depuis localhost pour SQLx et les outils de dev
host    dcop_413        dcop_user       host.docker.internal    scram-sha-256

# =============================================================================
# NOTES DE SÉCURITÉ
# =============================================================================

# 1. Utilisation de SCRAM-SHA-256 pour un chiffrement fort des mots de passe
# 2. Restriction des connexions aux réseaux Docker spécifiques
# 3. Refus explicite de toutes les autres connexions
# 4. Séparation des privilèges entre postgres (admin) et dcop_user (app)
# 5. Support IPv6 pour la compatibilité future
